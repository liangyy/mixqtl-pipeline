---
title: "Results on mixPred runs on GTEx V8 (performance comparison based on held out test data) taking 1/n part of data for training"
---

```{r setup}
rm(list = ls())
library(ggplot2)
theme_set(theme_bw(base_size = 13))
library(dplyr)
library(reshape2)
library(data.table)
library(pander)
options(datatable.fread.datatable = FALSE)
options(stringsAsFactors = FALSE)
panderOptions('table.split.table', Inf)
source('../code/rlib_analysis.R')
datadir = '/Users/yanyul/Desktop/mixqtl-pipeline-results/postprocess-prediction'
cbPalette <- c('ascQTL' = "#999999", 'mixPred' = "#E69F00", 'trcQTL' = "#56B4E9", 'standard' = "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
source('https://gist.githubusercontent.com/liangyy/43912b3ecab5d10c89f9d4b2669871c9/raw/3ca651cfa53ffccb8422f432561138a46e93710f/my_ggplot_theme.R')
# th$panel.border = element_rect(colour = th$axis.line$colour)
ifrun = FALSE
```

# Analysis plan

Regress out covariates as usual on the full data. 
And split the data into 10-part or 2-part partitions.
Run `mixPred` and `nePred` on each of the leave-one-part out data.
And evaluate the performance on the held out one part of the data.

# Load results

```{r load}
method_df = data.frame(method = c('mixpred', 'nepred'), tag = c('mixPred', 'standard'))
full_sample_size = 670
partitions = 2:10
out = list()
for(part in partitions) {
  for(i in 1 : nrow(method_df)) {
    if(part != 2) {
      tmp_ = read.table(paste0(datadir, '/', 'Whole_Blood-x-indiv_partition-gtex_v8_whole_blood_partition_', part, '-performance-', method_df$method[i], '.txt.gz'), header = T, )
    } else {
      tmp_ = read.table(paste0(datadir, '/', 'Whole_Blood-x-indiv_partition-gtex_v8_whole_blood_partition_', part, '_old-performance-', method_df$method[i], '.txt.gz'), header = T, )
    }
    
    out[[length(out) + 1]] = tmp_ %>% mutate(method = method_df$tag[i], split = part, sample_size = ceiling(full_sample_size / part))
  }
}
df = do.call(rbind, out)
```

<!-- # QC -->

<!-- ```{r} -->
<!-- passed_genes = df %>% filter(method == 'standard') %>% group_by(gene, sample_size, partition) %>% summarize(min_cor = min(pearson_correlation)) %>% filter(min_cor > -100) %>% pull(gene) -->
<!-- ``` -->

# Plot Pearson correlation comparison

Median correlation across partitions.

```{r plot_pearson_scatter, fig.height=6, fig.width=8}
p = df %>% group_by(gene, method, sample_size) %>% summarize(pearson = median(pearson_correlation)) %>% select(gene, pearson, method, sample_size) %>% dcast(gene + sample_size ~ method, value.var = 'pearson') %>% ggplot(aes(x = standard, y = mixPred)) + geom_point(alpha = .3) + geom_density2d(color = 'gray') + geom_abline(slope = 1, intercept = 0, color = 'gray') + facet_wrap(~sample_size, labeller = label_both, ncol=4) + th2 + coord_equal()
p 
ggsave(filename = '../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson_new.png', height = 6, width = 8)
```

All pairwise comparison.

```{r plot_pearson_box, fig.height=6, fig.width=8}
df %>% select(gene, pearson_correlation, method, partition, sample_size) %>% dcast(gene + partition + sample_size ~ method , value.var = 'pearson_correlation') %>% ggplot(aes(x = standard, y = mixPred)) + geom_point(alpha = .2) + geom_density2d(color = 'gray') + geom_abline(slope = 1, intercept = 0, color = 'gray') + facet_wrap(~sample_size, labeller = label_both, ncol=4) + th2 + coord_equal()
```

As violin plot.

```{r plot_pearson_box2, fig.height=6, fig.width=8}
p = df %>% select(gene, pearson_correlation, method, partition, sample_size) %>% ggplot(aes(x = method, y = pearson_correlation, fill = method)) + geom_violin() + geom_boxplot(width = .2) + facet_wrap(~sample_size, labeller = label_both) + th2 + scale_fill_manual(values = cbPalette) + theme(legend.position = 'bottom')
p 
# ggsave(filename = '../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson-violin_new.png', height = 4, width = 7)
```

```{r plot_pearson_box3, fig.height=3, fig.width=6}
tmp_ = df %>% group_by(method, sample_size) %>% summarize(n = n()) %>% ungroup()
df2 = df %>% left_join(tmp_, by = c('method', 'sample_size')) %>% mutate(tag = paste0(sample_size, '\n(', n, ')'))
df2$tag = factor(df2$tag, levels = unique(df2$tag[order(df2$sample_size)]))
p = df2 %>% select(gene, pearson_correlation, method, partition, sample_size, tag) %>% ggplot(aes(x = factor(tag), y = pearson_correlation, fill = method)) + geom_violin(position = position_dodge(width=0.8), alpha = 0.5) + geom_boxplot(width = .2, position = position_dodge(width=0.8), alpha = 0.5) + th + scale_fill_manual(values = cbPalette) + theme(legend.position = 'bottom') +
  ylab('Pearson correlation') + xlab('Sample size')

ggsave(filename = '../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson-violin_new.png', height = 3, width = 6)
ggsave(filename = '../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson-violin_new.pdf', height = 3, width = 6)
```


Paired t-test

```{r}
perform_t_test = function(method, gene, score) {
  df = data.frame(method, gene, score)
  df1 = df %>% filter(method == 'mixPred') 
  df2 = df %>% filter(method == 'standard') 
  dd = inner_join(df1, df2, by = 'gene')
  res = t.test(dd$score.x, dd$score.y, paired = T)
  return(data.frame(pairwise_diff = res$estimate, diff_ci95_low = res$conf.int[1], diff_ci95_high = res$conf.int[2], pval = res$p.value, median_mixpred = median(dd$score.x), median_standard = median(dd$score.y)))
}
```

```{r}
tmp = df %>% group_by(gene, method, sample_size) %>% summarize(pearson = median(pearson_correlation)) %>% select(gene, pearson, method, sample_size) %>% ungroup() %>% group_by(sample_size) %>% do(perform_t_test(.$method, .$gene, .$pearson))
oldnames = colnames(tmp)
tmp$nfold = round(670 / tmp$sample_size)
tmp = tmp[, c('nfold', oldnames)]
tmp %>% pander
tmp %>% write.csv('../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson-pairwise-ttest.csv', quote = F)
print(xtable::xtable(tmp, 
               type = "latex",
               digits = 3,
               display = c('s', 'd', 'd', 'f', 'f', 'f', 'e', 'f', 'f')
    ),
    include.rownames = FALSE,
    file = "../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson-pairwise-ttest.tex"
)
```

<!-- Sample size comparison -->

<!-- ```{r} -->
<!-- # two_cols = as.character(unique(df$sample_size)) -->
<!-- p = df %>% select(gene, pearson_correlation, method, partition, sample_size) %>% mutate(sample_size = paste('sample size =', sample_size)) %>% group_by(gene, sample_size, method) %>% summarize(pearson = median(pearson_correlation)) %>% dcast(gene + method ~ sample_size, value.var = 'pearson') %>% ggplot(aes(x = `sample size = 335`, y = `sample size = 603`)) + geom_point(alpha = .2) + geom_density2d(color = 'gray') + geom_abline(slope = 1, intercept = 0, color = 'gray') + facet_wrap(~method) + th -->
<!-- p -->
<!-- ggsave(filename = '../output/gtex-v8-pipeline-mixpred-with-gene-qc-pearson-2_new.png', height = 4, width = 7) -->
<!-- ``` -->